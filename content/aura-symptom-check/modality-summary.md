---
title: "Summary of Aura Symptoms"
linkTitle: "Summary"
description: "Overview of all your selected aura symptoms."
---

<div id="summaryOutput"></div>

<button id="downloadPdfBtn" class="btn">Download PDF Report</button>

<!-- Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>



<script type="module">
import { getDataFromLocalStorage } from '/js/aura-symptom-check/dataRetrieval.js';
import { generateNarrativeSummary } from '/js/aura-symptom-check/summaryGeneration.js';


// Function to load logo and maintain aspect ratio
async function loadImageAsBase64(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous"; // To handle cross-origin image loading
    img.onload = () => {
      console.log("Image loaded successfully:", img);
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      context.drawImage(img, 0, 0, img.width, img.height);
      resolve({ base64: canvas.toDataURL("image/png"), width: img.width, height: img.height });
    };
    img.onerror = (err) => {
      console.error("Error loading image:", err);
      reject(err);
    };
    img.src = url;
  });
}

// Header function to add title and logo
async function addPdfHeader(pdf, pageWidth) {
  const marginLeft = 20;
  const titleY = 15; // Y coordinate for the title
  const disclaimerY = 21; // Y coordinate for the disclaimer text
  const lineY = 23; // Y coordinate for the line below the header
  const logoMarginTop = 6; // Adjusted to position the logo higher

  pdf.setFont("helvetica", "bold").setFontSize(14);

  // Add title
  pdf.text("Migraine Aura Report", marginLeft, titleY);

  try {
    // Load logo and maintain aspect ratio
    const { base64, width, height } = await loadImageAsBase64("/images/report-logo.png");

    // Adjust the logo size to avoid stretching or distortion
    const logoHeight = 10;
    const logoWidth = (logoHeight * width) / height; // Maintain aspect ratio with height 10

    // Add logo to the header (right side)
    pdf.addImage(base64, "PNG", pageWidth - logoWidth - marginLeft, logoMarginTop, logoWidth, logoHeight);
  } catch (e) {
    console.warn("Logo missing:", e);
  }

  // Text under the logo and header
  pdf.setFontSize(9).setFont("helvetica", "normal");
  pdf.setTextColor(0);
  pdf.text("This automated report adheres to ICHD-3 criteria and is", marginLeft, disclaimerY);
  pdf.setTextColor(200, 0, 0);
  const prefix = "This automated report adheres to ICHD-3 criteria and is";
  const prefixWidth = pdf.getTextWidth(prefix);
  pdf.text(" not a substitute ", marginLeft + prefixWidth, disclaimerY);
  pdf.setTextColor(0);
  pdf.text("for professional medical diagnosis.", marginLeft + prefixWidth + pdf.getTextWidth(" not a substitute "), disclaimerY);
  pdf.line(marginLeft, lineY, pageWidth - marginLeft, lineY); // Line below the header
}

// Footer function to add page numbers and text at the bottom
function addPdfFooter(pdf, pageNum, pageHeight, pageWidth) {
  const marginLeft = 20;
  const marginBottom = 20;

  pdf.setFontSize(8).setTextColor(120).setFont("helvetica", "normal");
  pdf.text("Generated by Migraine Aura Foundation", marginLeft, pageHeight - marginBottom);
  pdf.text("www.migraine-aura-foundation.org", pageWidth - marginLeft, pageHeight - marginBottom, { align: "right" });
  pdf.setFontSize(7).setTextColor(150);
  pdf.text("This assessment is not a diagnosis.", marginLeft, pageHeight - marginBottom + 5);
}

// Main functionality for PDF generation
document.addEventListener("DOMContentLoaded", () => {
  const output = document.getElementById("summaryOutput");
  const downloadBtn = document.getElementById("downloadPdfBtn");

  // Retrieve data from localStorage
  const data = getDataFromLocalStorage();
  console.log("Data from localStorage:", data); // Debugging line

  // Generate narrative summary
  const summaryHtml = generateNarrativeSummary(data);
  console.log("Generated narrative summary:", summaryHtml); // Debugging line
  output.innerHTML = summaryHtml;

  downloadBtn.addEventListener("click", async () => {
    if (!window.jspdf) {
      alert("jsPDF failed to load. Please try again later.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const marginTop = 35;
    const marginBottom = 20;
    const marginLeft = 20;
    const marginRight = 20;
    const usableHeight = pageHeight - marginTop - marginBottom;
    const usableWidth = pageWidth - marginLeft - marginRight;

    let y = marginTop;

    // Add header (with logo)
    await addPdfHeader(pdf, pageWidth);

    // Extract and format content (split into paragraphs)
    const paragraphs = output.innerText.split("\n");
    console.log("Paragraphs to add to PDF:", paragraphs); // Debugging line

    // Set a consistent line height and margin
    const lineHeight = 6;

    // Add the content (each paragraph)
    paragraphs.forEach((text) => {
      if (y + lineHeight > pageHeight - marginBottom) {
        pdf.addPage();
        addPdfHeader(pdf, pageWidth);
        y = marginTop;
      }

      const lines = pdf.splitTextToSize(text, usableWidth);
      lines.forEach((line) => {
        pdf.setFont("helvetica", "normal").setFontSize(10).setTextColor(0);
        pdf.text(line, marginLeft, y);
        y += lineHeight;
      });
    });

    // Add footer
    addPdfFooter(pdf, 1, pageHeight, pageWidth);

    // Save the generated PDF
    pdf.save("Migraine-Aura-Report.pdf");
  });
});
</script>

<style>
  .btn {
    margin-top: 1rem;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background-color: #007bff;
    color: white;
  }

  .btn:hover {
    background-color: #0056b3;
  }
</style>
